<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nagasawakenji.walkfind.infra.mybatis.mapper.PhotoMapper">

    <resultMap id="UserPhotoResultMap" type="nagasawakenji.walkfind.domain.model.UserPhoto">
        <id property="id" column="id"/>
        <result property="contestId" column="contest_id"/>
        <result property="userId" column="user_id"/>
        <result property="photoUrl" column="photo_url"/>
        <result property="submissionDate" column="submission_date"/>
        <result property="totalVotes" column="total_votes"/>
        <result property="isApproved" column="is_approved"/>
    </resultMap>

    <resultMap id="PhotoResponseResultMap" type="nagasawakenji.walkfind.domain.dto.PhotoResponse">
        <id property="photoId" column="photoId"/>
        <result property="title" column="title"/>
        <result property="username" column="username"/>
        <result property="userId" column="userId"/>
        <result property="photoUrl" column="photoUrl"/>
        <result property="totalVotes" column="totalVotes"/>
        <result property="submissionDate" column="submissionDate"/>
    </resultMap>

    <resultMap id="UserPhotoResultMapForCalculation" type="nagasawakenji.walkfind.domain.model.UserPhoto">
        <!-- 集計処理に必要なフィールドのみ定義 -->
        <id property="id" column="id"/>
        <result property="totalVotes" column="total_votes"/>
        <result property="submissionDate" column="submission_date"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_photos
        (contest_id, user_id, photo_url, title, description, is_approved)
        VALUES
        (#{contestId}, #{userId}, #{photoUrl}, #{title}, #{description}, FALSE)
    </insert>

    <select id="findByContestAndUser" resultMap="UserPhotoResultMap">
        SELECT id, photo_url
        FROM user_photos
        WHERE contest_id = #{contestId} AND user_id = #{userId}
    </select>

    <select id="findAllPhotosByContest" resultMap="PhotoResponseResultMap">
        SELECT
        p.id AS photoId,
        p.title,
        u.username,
        u.id AS userId,
        p.photo_url AS photoUrl,
        p.total_votes AS totalVotes,
        p.submission_date AS submissionDate
        FROM user_photos p
        JOIN users u ON p.user_id = u.id
        WHERE p.contest_id = #{contestId}
        ORDER BY p.total_votes DESC, p.submission_date ASC
        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <select id="countTotalPhotos" resultType="long">
        SELECT
        COUNT(*)
        FROM user_photos
        WHERE contest_id = #{contestId}
    </select>

    <select id="findPhotoDetail" resultMap="UserPhotoResultMap">
        SELECT *
        FROM user_photos
        WHERE id = #{photoId}
    </select>

    <update id="incrementTotalVotes">
        UPDATE user_photos
        SET total_votes = total_votes + 1, updated_at = CURRENT_TIMESTAMP
        WHERE id = #{photoId}
    </update>

    <!-- ★ 集計対象の投稿リストを取得 (total_votesが多い順、submission_dateが古い順) ★ -->
    <!-- ResultCalculationService.javaで使用 -->
    <select id="findAllSubmissionsForCalculation" resultMap="UserPhotoResultMapForCalculation">
        SELECT
        id,
        total_votes,
        submission_date
        FROM user_photos
        WHERE contest_id = #{contestId}
        ORDER BY total_votes DESC, submission_date ASC
    </select>


</mapper>