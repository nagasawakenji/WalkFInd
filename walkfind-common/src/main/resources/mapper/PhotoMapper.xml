<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nagasawakenji.walkfind.infra.mybatis.mapper.PhotoMapper">

    <resultMap id="UserPhotoResultMap" type="nagasawakenji.walkfind.domain.model.UserPhoto">
        <id property="id" column="id"/>
        <result property="contestId" column="contest_id"/>
        <result property="userId" column="user_id"/>
        <result property="photoUrl" column="photo_url"/>
        <result property="submissionDate" column="submission_date"/>
        <result property="totalVotes" column="total_votes"/>
        <result property="isApproved" column="is_approved"/>
        <result property="removedAt" column="removed_at"/>
        <result property="removedByUserId" column="removed_by_user_id"/>
    </resultMap>

    <resultMap id="PhotoResponseResultMap" type="nagasawakenji.walkfind.domain.dto.PhotoResponse">
        <id property="photoId" column="photoId"/>
        <result property="title" column="title"/>
        <result property="username" column="username"/>
        <result property="userId" column="userId"/>
        <result property="photoUrl" column="photoUrl"/>
        <result property="totalVotes" column="totalVotes"/>
        <result property="submissionDate" column="submissionDate"/>
    </resultMap>

    <resultMap id="UserPhotoResultMapForCalculation" type="nagasawakenji.walkfind.domain.model.UserPhoto">
        <!-- 集計処理に必要なフィールドのみ定義 -->
        <id property="id" column="id"/>
        <result property="totalVotes" column="total_votes"/>
        <result property="submissionDate" column="submission_date"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO user_photos
        (contest_id, user_id, photo_url, title, description, is_approved)
        VALUES
        (#{contestId}, #{userId}, #{photoUrl}, #{title}, #{description}, FALSE)
    </insert>

    <select id="findByContestAndUser" resultMap="UserPhotoResultMap">
        SELECT p.id, p.photo_url
        FROM user_photos p
        JOIN contests c ON p.contest_id = c.id
        WHERE p.contest_id = #{contestId}
          AND p.user_id = #{userId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </select>

    <select id="findAllPhotosByContest" resultMap="PhotoResponseResultMap">
        SELECT
        p.id AS photoId,
        p.title,
        u.username,
        u.id AS userId,
        p.photo_url AS photoUrl,
        p.total_votes AS totalVotes,
        p.submission_date AS submissionDate
        FROM user_photos p
        JOIN users u ON p.user_id = u.id
        JOIN contests c ON p.contest_id = c.id
        WHERE p.contest_id = #{contestId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
        ORDER BY p.total_votes DESC, p.submission_date ASC
        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <select id="countTotalPhotos" resultType="long">
        SELECT
        COUNT(*)
        FROM user_photos p
        JOIN contests c ON p.contest_id = c.id
        WHERE p.contest_id = #{contestId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </select>

    <select id="findPhotoDetail" resultMap="UserPhotoResultMap">
        SELECT p.*
        FROM user_photos p
        JOIN contests c ON p.contest_id = c.id
        WHERE p.id = #{photoId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </select>

    <update id="incrementTotalVotes">
        UPDATE user_photos p
        SET total_votes = p.total_votes + 1,
            updated_at = CURRENT_TIMESTAMP
        FROM contests c
        WHERE p.id = #{photoId}
          AND p.contest_id = c.id
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </update>

    <!-- ★ 集計対象の投稿リストを取得 (total_votesが多い順、submission_dateが古い順) ★ -->
    <!-- ResultCalculationService.javaで使用 -->
    <select id="findAllSubmissionsForCalculation" resultMap="UserPhotoResultMapForCalculation">
        SELECT
        p.id,
        p.total_votes,
        p.submission_date
        FROM user_photos p
        JOIN contests c ON p.contest_id = c.id
        WHERE p.contest_id = #{contestId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
        ORDER BY total_votes DESC, submission_date ASC
    </select>

    <!-- photoId で写真を取得する -->
    <select id="findById" resultMap="UserPhotoResultMap">
        SELECT
            p.id,
            p.contest_id,
            p.user_id,
            p.photo_url,
            p.submission_date,
            p.total_votes,
            p.is_approved
        FROM user_photos p
        JOIN contests c ON p.contest_id = c.id
        WHERE p.id = #{photoId}
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </select>

    <!-- contestId + photoId で写真を取得する（論理削除済みも含む。Service側で removed_at を判定する） -->
    <select id="findByIdAndContestId" resultMap="UserPhotoResultMap">
        SELECT
            p.id,
            p.contest_id,
            p.user_id,
            p.photo_url,
            p.title,
            p.description,
            p.submission_date,
            p.total_votes,
            p.is_approved,
            p.removed_at,
            p.removed_by_user_id
        FROM user_photos p
        WHERE p.contest_id = #{contestId}
          AND p.id = #{photoId}
    </select>

    <!-- 管理者による論理削除（removed_at をセット） -->
    <update id="logicalDeleteByIdForAdmin">
        UPDATE user_photos
        SET
            removed_at = CURRENT_TIMESTAMP,
            removed_by_user_id = #{removedByUserId},
            updated_at = CURRENT_TIMESTAMP
        WHERE contest_id = #{contestId}
          AND id = #{photoId}
          AND removed_at IS NULL
    </update>

    <!-- photoId で写真を削除する -->
    <delete id="deleteById">
        DELETE FROM user_photos p
        USING contests c
        WHERE p.id = #{photoId}
          AND p.contest_id = c.id
          AND p.removed_at IS NULL
          AND c.removed_at IS NULL
    </delete>





</mapper>