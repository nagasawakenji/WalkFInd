<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="nagasawakenji.walkfind.infra.mybatis.mapper.ContestMapper">

    <resultMap id="ContestResultMap" type="nagasawakenji.walkfind.domain.model.Contest">
        <id property="id" column="id"/>

        <result property="name" column="name"/>
        <result property="theme" column="theme"/>

        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>

        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>

        <result property="createdByUserId" column="created_by_user_id"/>

        <result property="removedAt" column="removed_at"/>

        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findAllActiveContests" resultMap="ContestResultMap">
        SELECT id, name, theme, start_date, end_date, status, created_at, updated_at
        FROM contests
        WHERE status IN ('UPCOMING', 'IN_PROGRESS')
          AND removed_at IS NULL
        ORDER BY start_date ASC
    </select>

    <select id="findAnnouncedContest" resultMap="ContestResultMap">
        SELECT id, name, theme, start_date, end_date, status, created_at, updated_at
        FROM contests
        WHERE status = 'ANNOUNCED'
          AND removed_at IS NULL
        ORDER BY end_date DESC
        LIMIT #{size}
        OFFSET #{size} * #{page}
    </select>

    <select id="findById" resultMap="ContestResultMap">
        SELECT *
        FROM contests
        WHERE id = #{contestId}
          AND removed_at IS NULL
    </select>

    <select id="findContestStatus" resultMap="ContestResultMap">
        SELECT status, start_date, end_date
        FROM contests
        WHERE id = #{contestId}
          AND removed_at IS NULL
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO contests (name, theme, start_date, end_date, status, created_by_user_id)
        VALUES (#{name}, #{theme}, #{startDate}, #{endDate}, #{status}, #{createdByUserId})
    </insert>

    <!-- 集計が必要なコンテストを取得する (findContestsNeedingCalculation) -->
    <select id="findContestsNeedingCalculation" resultMap="ContestResultMap">
        SELECT id, name, theme, start_date, end_date, status, created_at, updated_at
        FROM contests
        WHERE end_date <![CDATA[ < ]]> CURRENT_TIMESTAMP
          AND status = 'CLOSED_VOTING'
          AND removed_at IS NULL
        ORDER BY end_date ASC
    </select>

    <!-- コンテストのステータスを更新する (updateContestStatus) -->
    <update id="updateContestStatus">
        UPDATE contests
        SET status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
        updated_at = CURRENT_TIMESTAMP
        WHERE id = #{contestId}
          AND removed_at IS NULL
    </update>

    <!-- コンテストの存在判定を名前から実行する -->
    <select id="isExistContestByName" resultType="boolean">
        SELECT EXISTS(
        SELECT 1
        FROM contests
        WHERE name = #{name}
          AND removed_at IS NULL
        )
    </select>

    <!-- コンテストの状態アップデート -->
    <update id="updateToInProgress">
        UPDATE contests
        SET status = 'IN_PROGRESS'
        WHERE status = 'UPCOMING'
          AND start_date <![CDATA[ <= ]]> #{now}
          AND removed_at IS NULL
    </update>

    <update id="updateToClosedVoting">
        UPDATE contests
        SET status = 'CLOSED_VOTING'
        WHERE status = 'IN_PROGRESS'
          AND end_date <![CDATA[ <= ]]> #{now}
          AND removed_at IS NULL
    </update>

    <update id="updateToAnnouncedIfCalculated">
        UPDATE contests
        SET status = 'ANNOUNCED'
        WHERE status = 'CLOSED_VOTING'
          AND aggregation_completed = true
          AND removed_at IS NULL
    </update>

    <!-- コンテスト情報を更新する -->
    <update id="update" parameterType="nagasawakenji.walkfind.domain.model.Contest">
        UPDATE contests
        SET
            name = #{name},
            theme = #{theme},
            start_date = #{startDate},
            end_date = #{endDate},
            status = #{status, typeHandler=org.apache.ibatis.type.EnumTypeHandler},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
          AND removed_at IS NULL
    </update>

    <!-- コンテストをIDで論理削除する -->
    <update id="deleteById">
        UPDATE contests
        SET removed_at = CURRENT_TIMESTAMP,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{contestId}
          AND removed_at IS NULL
    </update>

    <!-- 自分の作成したコンテストのうち、upcomingのものを取得する -->
    <select id="findMyUpcomingContests"
            resultType="nagasawakenji.walkfind.domain.dto.MyContestResponse">
        SELECT
        id AS contestId,
        name,
        theme,
        start_date AS startDate,
        end_date AS endDate,
        status
        FROM contests
        WHERE created_by_user_id = #{userId}
        AND status = 'UPCOMING'
        AND removed_at IS NULL
        ORDER BY start_date ASC
        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <!-- 自分の作成したコンテストのうち、upcomingのものの件数を取得する -->
    <select id="countMyUpcomingContests" resultType="long">
        SELECT COUNT(*)
        FROM contests
        WHERE created_by_user_id = #{userId}
        AND status = 'UPCOMING'
        AND removed_at IS NULL
    </select>

    <select id="findAdminContests" resultType="nagasawakenji.walkfind.domain.dto.AdminContestResponse">
        SELECT
        id AS contestId,
        name,
        theme,
        start_date AS startDate,
        end_date AS endDate,
        status,
        created_by_user_id AS createdByUserId,
        removed_at AS removedAt
        FROM contests
        WHERE 1=1
        <if test="includeRemoved == false">
            AND removed_at IS NULL
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (name ILIKE '%' || #{keyword} || '%' OR theme ILIKE '%' || #{keyword} || '%')
        </if>
        ORDER BY created_at DESC
        LIMIT #{size}
        OFFSET #{offset}
    </select>

    <select id="countAdminContests" resultType="long">
        SELECT COUNT(*)
        FROM contests
        WHERE 1=1
        <if test="includeRemoved == false">
            AND removed_at IS NULL
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        <if test="keyword != null and keyword != ''">
            AND (name ILIKE '%' || #{keyword} || '%' OR theme ILIKE '%' || #{keyword} || '%')
        </if>
    </select>

</mapper>